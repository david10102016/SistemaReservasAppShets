<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administraci√≥n - Sal√≥n de Belleza/Barber√≠a</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
        }

        .login-box h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .login-box p {
            color: #666;
            margin-bottom: 30px;
        }

        .login-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        #googleSignInBtn {
            margin: 20px auto;
        }

        #dashboard {
            display: none;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header-left h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header-left p {
            opacity: 0.9;
            font-size: 14px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            text-align: right;
        }

        .user-email {
            font-size: 14px;
            opacity: 0.9;
        }

        .btn-logout {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: white;
            color: #667eea;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: #666;
            font-size: 14px;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filters label {
            font-weight: 600;
            color: #333;
        }

        .filters input, .filters select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .filters button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .filters button:hover {
            background: #5568d3;
        }

        .appointments-table {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            color: #555;
        }

        tr:hover {
            background: #f8f9ff;
        }

        .status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status.Confirmada {
            background: #d1fae5;
            color: #065f46;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .btn-action {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-whatsapp {
            background: #25d366;
            color: white;
        }

        .btn-whatsapp:hover {
            background: #1da851;
            transform: translateY(-2px);
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-confirm {
            background: #ef4444;
            color: white;
        }

        .btn-cancel {
            background: #e5e7eb;
            color: #333;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }

            .stats {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <div class="login-icon">üîí</div>
            <h1>Panel de Administraci√≥n</h1>
            <p>Sal√≥n de Belleza/Barber√≠a</p>
            <p style="font-size: 14px; color: #999;">Inicia sesi√≥n para gestionar las citas</p>
            <div id="googleSignInBtn"></div>
        </div>
    </div>

    <div id="dashboard">
        <div class="header">
            <div class="header-left">
                <h1>üìä Panel de Administraci√≥n</h1>
                <p>Gestiona las citas de tu sal√≥n</p>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div style="font-size: 12px; opacity: 0.8;">Sesi√≥n iniciada como:</div>
                    <div class="user-email" id="userEmail"></div>
                </div>
                <button class="btn-logout" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="number" id="citasHoy">0</div>
                <div class="label">Citas hoy</div>
            </div>
            <div class="stat-card">
                <div class="number" id="citasSemana">0</div>
                <div class="label">Citas esta semana</div>
            </div>
            <div class="stat-card">
                <div class="number" id="citasMes">0</div>
                <div class="label">Citas este mes</div>
            </div>
            <div class="stat-card">
                <div class="number" id="ingresosMes">Bs 0</div>
                <div class="label">Ingresos estimados</div>
            </div>
        </div>

        <div class="filters">
            <div>
                <label>Fecha:</label>
                <input type="date" id="filterFecha">
            </div>
            <div>
                <label>Barbero:</label>
                <select id="filterBarbero">
                    <option value="">Todos</option>
                </select>
            </div>
            <button onclick="filtrarCitas()">üîç Filtrar</button>
            <button onclick="limpiarFiltros()" style="background: #6b7280;">üîÑ Limpiar</button>
        </div>

        <div class="appointments-table">
            <h2 style="margin-bottom: 20px; color: #333;">Citas Registradas</h2>
            <table id="appointmentsTable">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Cliente</th>
                        <th>Tel√©fono</th>
                        <th>Servicio</th>
                        <th>Profesional</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="appointmentsBody">
                </tbody>
            </table>
            <div class="no-data" id="noData" style="display: none;">
                No hay citas registradas
            </div>
        </div>
    </div>

    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <h2>‚ö†Ô∏è Confirmar cancelaci√≥n</h2>
            <p>¬øEst√°s seguro de que deseas cancelar esta cita?</p>
            <p style="color: #666; font-size: 14px; margin-top: 10px;">
                <strong>Cliente:</strong> <span id="deleteClientName"></span><br>
                <strong>Fecha:</strong> <span id="deleteClientDate"></span>
            </p>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="cerrarModal()">Cancelar</button>
                <button class="btn-confirm" onclick="confirmarEliminacion()">Cancelar Cita</button>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzbfQtjvwzXXr-TKyF-CdXv1nTKOeCMEsWbOscJcZ49it3jqlKp9lLCapeUHaWbG-Wx/exec';
        const GOOGLE_CLIENT_ID = '75192488090-ptvidrt7qjmrqp938uq6dnglhgku2no9.apps.googleusercontent.com';
        
        const EMAILS_AUTORIZADOS = [
            'creativo777si@gmail.com',
            'lucinda.lupati777@gmail.com',
            'empleado@gmail.com'
        ];

        let usuarioActual = null;
        let citaAEliminar = null;
        let citas = [];
        let todasLasCitas = [];

        window.onload = function() {
            google.accounts.id.initialize({
                client_id: GOOGLE_CLIENT_ID,
                callback: manejarCredencial
            });

            google.accounts.id.renderButton(
                document.getElementById('googleSignInBtn'),
                { 
                    theme: 'filled_blue', 
                    size: 'large',
                    text: 'signin_with',
                    width: 300
                }
            );
        };

        function manejarCredencial(response) {
            const credential = parseJwt(response.credential);
            const email = credential.email;

            if (EMAILS_AUTORIZADOS.includes(email)) {
                usuarioActual = email;
                mostrarDashboard();
            } else {
                alert('‚ùå Acceso denegado.\n\nEste email no tiene permiso para acceder al panel de administraci√≥n.\n\nContacta al administrador del sistema.');
            }
        }

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('Error parsing JWT:', error);
                return { email: '' };
            }
        }

        async function mostrarDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('userEmail').textContent = usuarioActual;
            
            await cargarCitasDesdeBackend();
            await cargarBarberosEnFiltro();
        }

        function cerrarSesion() {
            google.accounts.id.disableAutoSelect();
            usuarioActual = null;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
        }

        async function cargarCitasDesdeBackend() {
            try {
                const response = await fetch(SCRIPT_URL + '?accion=obtenerCitas');
                const result = await response.json();
                
                if (result.success && result.citas) {
                    todasLasCitas = result.citas;
                    citas = result.citas;
                    cargarCitas();
                    actualizarEstadisticas();
                } else {
                    document.getElementById('noData').style.display = 'block';
                }
            } catch (error) {
                console.error('Error cargando citas:', error);
                document.getElementById('noData').style.display = 'block';
            }
        }

        async function cargarBarberosEnFiltro() {
            try {
                const response = await fetch(SCRIPT_URL + '?accion=obtenerBarberos');
                const barberos = await response.json();
                
                const selectBarbero = document.getElementById('filterBarbero');
                selectBarbero.innerHTML = '<option value="">Todos</option>';
                
                if (barberos && barberos.length > 0) {
                    barberos.forEach(b => {
                        const option = document.createElement('option');
                        option.value = b.nombre || b;
                        option.textContent = b.nombre || b;
                        selectBarbero.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error cargando barberos:', error);
            }
        }

        function cargarCitas(citasFiltradas = null) {
            const tbody = document.getElementById('appointmentsBody');
            const citasAMostrar = citasFiltradas || citas;
            
            if (!citasAMostrar || citasAMostrar.length === 0) {
                tbody.innerHTML = '';
                document.getElementById('noData').style.display = 'block';
                return;
            }

            document.getElementById('noData').style.display = 'none';
            
            tbody.innerHTML = citasAMostrar.map(cita => `
                <tr>
                    <td>${formatearFecha(cita.fecha)}</td>
                    <td><strong>${formatearHora(cita.hora)}</strong></td>
                    <td>${cita.nombre || ''}</td>
                    <td>${cita.telefono || ''}</td>
                    <td>${cita.servicio || ''}</td>
                    <td>${cita.barbero || ''}</td>
                    <td><span class="status ${cita.estado || 'Confirmada'}">${cita.estado || 'Confirmada'}</span></td>
                    <td>
                        <div class="actions">
                            <button class="btn-action btn-whatsapp" onclick="abrirWhatsApp('${cita.telefono || ''}', '${cita.nombre || ''}', '${cita.fecha || ''}', '${cita.hora || ''}')">
                                üí¨ WhatsApp
                            </button>
                            <button class="btn-action btn-delete" onclick="abrirModalEliminar(${cita.id || 0}, '${cita.nombre || ''}', '${cita.fecha || ''}')">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function formatearFecha(fecha) {
            if (!fecha) return '';
            
            try {
                let fechaObj;
                
                if (fecha instanceof Date) {
                    fechaObj = fecha;
                } else if (typeof fecha === 'string' && fecha.includes('T')) {
                    fechaObj = new Date(fecha);
                } else if (typeof fecha === 'string' && fecha.includes('-')) {
                    fechaObj = new Date(fecha + 'T00:00:00');
                } else {
                    fechaObj = new Date(fecha);
                }
                
                if (isNaN(fechaObj.getTime())) {
                    return fecha;
                }
                
                return fechaObj.toLocaleDateString('es-BO', {
                    weekday: 'short',
                    day: 'numeric',
                    month: 'short'
                });
                
            } catch (error) {
                console.error('Error formateando fecha:', fecha, error);
                return String(fecha);
            }
        }

        function formatearHora(hora) {
            if (!hora) return '';
            
            if (hora.includes('T') && hora.includes('Z')) {
                try {
                    const fecha = new Date(hora);
                    return fecha.toLocaleTimeString('es-BO', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                } catch (e) {
                    return hora;
                }
            }
            
            return hora;
        }

        function abrirWhatsApp(telefono, nombre, fecha, hora) {
            if (!telefono) {
                alert('No hay tel√©fono registrado para este cliente');
                return;
            }
            
            const numeroLimpio = telefono.replace(/\D/g, '');
            const fechaFormateada = formatearFecha(fecha);
            const mensaje = `Hola ${nombre || 'cliente'}, te confirmamos tu cita para el ${fechaFormateada} a las ${formatearHora(hora)}. ¬°Te esperamos! üíà`;
            const url = `https://wa.me/591${numeroLimpio}?text=${encodeURIComponent(mensaje)}`;
            window.open(url, '_blank');
        }

        function abrirModalEliminar(id, nombre, fecha) {
            citaAEliminar = id;
            document.getElementById('deleteClientName').textContent = nombre || 'Cliente';
            document.getElementById('deleteClientDate').textContent = formatearFecha(fecha) || fecha;
            document.getElementById('deleteModal').classList.add('show');
        }

        function cerrarModal() {
            document.getElementById('deleteModal').classList.remove('show');
            citaAEliminar = null;
        }

        async function confirmarEliminacion() {
            if (!citaAEliminar) return;
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        accion: 'eliminarCita',
                        id: citaAEliminar
                    })
                });
                
                if (response.ok) {
                    await cargarCitasDesdeBackend();
                    cerrarModal();
                    alert('Cita cancelada exitosamente');
                } else {
                    throw new Error('Error en la respuesta');
                }
            } catch (error) {
                alert('Error al cancelar la cita');
                console.error(error);
            }
        }

        function filtrarCitas() {
            const fecha = document.getElementById('filterFecha').value;
            const barbero = document.getElementById('filterBarbero').value;

            let citasFiltradas = todasLasCitas;

            if (fecha) {
                citasFiltradas = citasFiltradas.filter(c => c.fecha === fecha);
            }

            if (barbero) {
                citasFiltradas = citasFiltradas.filter(c => c.barbero === barbero);
            }

            citas = citasFiltradas;
            cargarCitas(citasFiltradas);
            actualizarEstadisticas();
        }

        function limpiarFiltros() {
            document.getElementById('filterFecha').value = '';
            document.getElementById('filterBarbero').value = '';
            citas = todasLasCitas;
            cargarCitas();
            actualizarEstadisticas();
        }

        function actualizarEstadisticas() {
            if (!citas || citas.length === 0) {
                document.getElementById('citasHoy').textContent = 0;
                document.getElementById('citasSemana').textContent = 0;
                document.getElementById('citasMes').textContent = 0;
                document.getElementById('ingresosMes').textContent = 'Bs 0';
                return;
            }

            const hoy = new Date().toISOString().split('T')[0];
            const inicioSemana = new Date();
            inicioSemana.setDate(inicioSemana.getDate() - inicioSemana.getDay());
            const inicioMes = new Date();
            inicioMes.setDate(1);

            const citasHoy = citas.filter(c => c.fecha === hoy).length;
            const citasSemana = citas.filter(c => {
                const fechaCita = new Date(c.fecha + 'T00:00:00');
                return fechaCita >= inicioSemana;
            }).length;
            
            const citasMes = citas.filter(c => {
                const fechaCita = new Date(c.fecha + 'T00:00:00');
                return fechaCita.getMonth() === inicioMes.getMonth() && 
                       fechaCita.getFullYear() === inicioMes.getFullYear();
            }).length;

            const ingresosMes = citas
                .filter(c => {
                    const fechaCita = new Date(c.fecha + 'T00:00:00');
                    return fechaCita.getMonth() === inicioMes.getMonth() && 
                           fechaCita.getFullYear() === inicioMes.getFullYear();
                })
                .reduce((total, c) => total + (c.precio || 0), 0);

            document.getElementById('citasHoy').textContent = citasHoy;
            document.getElementById('citasSemana').textContent = citasSemana;
            document.getElementById('citasMes').textContent = citasMes;
            document.getElementById('ingresosMes').textContent = `Bs ${ingresosMes.toLocaleString()}`;
        }
    </script>
</body>
</html>